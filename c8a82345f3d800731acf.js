let _theMailItem={to:"",sender:"",subject:"",date:"",cc:"",body:"",attachments:[]},recipString="",recipientOneEmail="",toArray=[];Office.onReady((e=>{if(e.host===Office.HostType.Outlook){recipString="",document.querySelector("#cflex-init").style.display="none",console.log("Flex365x Outlook Addin: compose"),document.querySelector("#cflex-app-body").style.display="flex";const e=setInterval((()=>{if(document.querySelector("#cflex-app-body").checkVisibility()){const e=Office.context.mailbox.item;toArray=[];let t="";e.to.getAsync((e=>{for(let n=0;n<e.value.length;n++){const a=e.value[n];""===recipientOneEmail&&(recipientOneEmail=a.emailAddress),toArray.push({displayName:a.displayName,emailAddress:a.emailAddress}),t+=a.emailAddress}updateComposeUI(t!=recipString,toArray,recipientOneEmail),recipString=t}))}else clearInterval(e)}),1e3)}}));const getEmailString2=e=>{let t=e.displayName;return-1===e.displayName.indexOf("@")&&(t+=" ("+e.emailAddress+")"),t},getEMLFile2=e=>{let t="";const n=(e,t)=>{let n="";const a=[];let i=0,o="";do{o=e.substr(i,t),""!==o&&a.push(o),i+=t}while(""!==o);return a.length>-1&&(n=a.join("\r\n")),n};t+=`To: ${e.to}\r\nFrom: ${e.sender}\r\nCC: ${e.cc}\r\nSubject: ${e.subject}\r\nDate: ${(new Date).toUTCString()}\r\n`,t+="Content-Type: multipart/mixed; boundary=--boundary_text_string\r\n",t+="\r\n----boundary_text_string\r\nContent-Type: text/html; charset=ISO-8859-1\r\n",t+="Content-Transfer-Encoding: quoted-printable\r\n\r\n",t+="<html><head></head><body>",void 0!==e.body&&(t+=e.body),t+="</body></html>";for(const a of e.attachments)t+="\r\n\r\n----boundary_text_string\r\n",t+=`Content-Type: ${a.contentType}; name="${a.name}"\r\n`,t+=`Content-Disposition: attachment; filename="${a.name}"; size=${a.size.toString()}\r\n`,t+="Content-Transfer-Encoding: base64\r\n\r\n",t+=`${n(a.base64Content,76)}`;return t+="\r\n\r\n----boundary_text_string--",console.log(t),t},openFlexSite=e=>{window.open(`https://44g7q3.sharepoint.com/sites/Flex/SitePages/CollabHome.aspx?sw=bypass&search=${e}`)},updateComposeUI=(e,t,n)=>new Promise((a=>{const i=Office.context.mailbox.item,o=document.querySelector("#cflex-app-body"),l=document.querySelector("#cflex-select-item-prompt"),s=document.querySelector("#cflex-wait"),c=document.querySelector("#cflex-search-to-container"),r=document.querySelector("#cflex-search-link-sender-name"),d=document.querySelector("#cflex-search-link-sender-address");c&&r&&d&&o&&l&&s?e&&(o.style.display="none",l.style.display="none",s.style.display="flex",c.replaceChildren(),r.replaceChildren(),d.replaceChildren()):a(),i||(s.style.display="none",l.style.display="flex",a()),_theMailItem={to:"",sender:"",subject:"",date:"",cc:"",body:"",attachments:[]},_theMailItem.sender=`${Office.context.mailbox.userProfile.displayName} (${Office.context.mailbox.userProfile.emailAddress})`;const m=[];t.forEach((e=>{""===n&&(n=e.emailAddress),_theMailItem.to.length>0&&(_theMailItem.to+="; "),_theMailItem.to+=getEmailString2(e),m.push({displayName:e.displayName,emailAddress:e.emailAddress})})),i.cc.getAsync((e=>{e.value.forEach((e=>{_theMailItem.cc.length>0&&(_theMailItem.cc+="; "),theMailItem.cc+=getEmailString2(e)})),i.body.getAsync(Office.CoercionType.Html,null,(e=>{_theMailItem.body=e.value,i.subject.getAsync((e=>{_theMailItem.subject=e.value;const t=[];i.getAttachmentsAsync((e=>{for(const n of e.value)t.push(getAttachmentsContent2(i,n.id));Promise.all(t).then((()=>{const e=document.querySelector("#cflex-drag-envelope");e&&e.addEventListener("dragstart",composeDragger);const t=document.createElement("a");t.href="javascript:void(0)",t.innerText=Office.context.mailbox.userProfile.displayName,t.style.paddingRight="20px",t.addEventListener("click",(()=>openFlexSite(`${Office.context.mailbox.userProfile.displayName}`))),r.replaceChildren(),r.append(t);const n=document.createElement("a");n.href="javascript:void(0)",n.innerText=Office.context.mailbox.userProfile.emailAddress,n.addEventListener("click",(()=>openFlexSite(`${Office.context.mailbox.userProfile.emailAddress}`))),d.replaceChildren(),d.append(n);const a=document.querySelector("#cflex-search-to-container");a&&(a.replaceChildren(),m.forEach((e=>{if(e.emailAddress!==Office.context.mailbox.emailAddress){const t=document.createElement("div"),n=document.createElement("a");if(n.href="javascript:void(0)",n.innerHTML=`${e.displayName}`,n.addEventListener("click",(()=>openFlexSite(`${n.innerHTML}`))),t.appendChild(n),a.children.length>0&&(t.style.paddingTop="10px"),a.appendChild(t),e.displayName!==e.emailAddress){const t=document.createElement("div"),n=document.createElement("a");n.href="javascript:void(0)",n.innerHTML=`${e.emailAddress}`,n.addEventListener("click",(()=>openFlexSite(`${n.innerHTML}`))),t.appendChild(n),a.appendChild(t)}}})))})),s.style.display="none",l.style.display="none",o.style.visibility="hidden",o.style.display="flex";const n=c;n.style.resize="",n.style.overflow="",n.style.height="auto",n.getBoundingClientRect().height>120&&(n.style.resize="vertical",n.style.overflow="auto",n.style.height="120px"),o.style.visibility=""}))}))}))}))})),getAttachmentsContent2=(e,t)=>new Promise((n=>{e.getAttachmentContentAsync(t,(e=>{_theMailItem.attachments.push({id:t,name:e.value.name,contentType:e.value.contentType,size:e.valuet.size,base64Content:e.value.content}),n()}))})),composeDragger=e=>{console.log(JSON.stringify({to:_theMailItem.to,sender:_theMailItem.sender,subject:_theMailItem.subject,date:(new Date).toUTCString(),cc:_theMailItem.cc,body:_theMailItem.body,numAttachments:_theMailItem.attachments.length.toString(),filename:`${_theMailItem.subject.replace(/[^a-z0-9+]+/gi,"_")}_${(new Date).getMilliseconds().toString()}${Math.floor(1e3*Math.random())}.eml`,eml:getEMLFile2(_theMailItem)})),e.dataTransfer.setData("text",JSON.stringify({to:_theMailItem.to,sender:_theMailItem.sender,subject:_theMailItem.subject,date:(new Date).toUTCString(),cc:_theMailItem.cc,body:_theMailItem.body,numAttachments:_theMailItem.attachments.length.toString(),filename:`${_theMailItem.subject.replace(/[^a-z0-9+]+/gi,"_")}_${(new Date).getMilliseconds().toString()}${Math.floor(1e3*Math.random())}.eml`,eml:getEMLFile2(_theMailItem)}))};function onMessageComposeHandler(e){console.log("onMessageComposeHandler(): entered!");var t={asyncContext:{callingEvent:e}};Office.context.mailbox.item.notificationMessages.addAsync("showInfoBarForSampleInstructions",{type:Office.MailboxEnums.ItemNotificationMessageType.InsightMessage,message:"Open the Task Pane to save to Flex",icon:"Icon.16x16",actions:[{actionText:"Show Flex365x Task Pane",actionType:Office.MailboxEnums.ActionType.ShowTaskPane,commandId:"msgComposeOpenPaneButton",contextData:"{''}"}]},t,(function(e){console.log("onMessageComposeHandler(): Notification message added"),e.asyncContext.callingEvent.completed()}))}Office.actions.associate("onMessageComposeHandler",onMessageComposeHandler);